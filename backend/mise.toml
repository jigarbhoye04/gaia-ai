# Backend mise.toml for GAIA
# This file defines tasks for the GAIA backend (Python/FastAPI).
#
# Quick Start:
#   mise dev             # Start development server
#   mise install         # Install dependencies
#   mise tasks               # List all available commands

[tools]
mprocs = "0.7.3"
python = "3.11"

[env]
PROJECT_NAME = "{{ config_root | basename }}"

[settings]
python.uv_venv_auto = true

[tasks.dev]
description = "Run development server with hot reload"
run = "uv run uvicorn app.main:app --port 8000 --reload --log-level warning"

[tasks.start]
description = "Run production server"
run = "uv run fastapi run"

[tasks.worker]
description = "Start ARQ worker"
run = "uv run arq app.worker.WorkerSettings"
alias = "arq"

[tasks.lint]
description = "Run ruff linter"
run = "uvx ruff check ."

[tasks."lint:fix"]
description = "Run ruff linter with auto-fix"
run = "uvx ruff check . --fix"

[tasks.format]
description = "Format code with ruff"
run = "uvx ruff format ."

[tasks.mypy]
description = "Run mypy type checker"
run = "uvx mypy app --ignore-missing-imports"

[tasks.schema]
description = "Test API schema with schemathesis"
run = "uvx schemathesis run http://localhost:8000/openapi.json"

[tasks."schema:write"]
description = "Test API schema and write report"
run = "uvx schemathesis run http://localhost:8000/openapi.json --report-junit-path report.xml"

[tasks.bandit]
description = "Run bandit security scanner"
run = "uvx bandit -r app"

[tasks."pip:audit"]
description = "Audit pip packages for vulnerabilities"
run = "uvx pip-audit"

[tasks.secrets]
description = "Detect secrets in codebase"
run = "uvx detect-secrets scan --all-files"

[tasks.precommit]
description = "Run all pre-commit checks (ruff, mypy, bandit, pip-audit, detect-secrets)"
run = "pre-commit run --all-files"

[tasks."precommit:ruff"]
description = "Run ruff linter (pre-commit hook)"
run = "pre-commit run ruff --all-files"

[tasks."precommit:ruff-format"]
description = "Run ruff formatter (pre-commit hook)"
run = "pre-commit run ruff-format --all-files"

[tasks."precommit:trailing-whitespace"]
description = "Check trailing whitespace (pre-commit hook)"
run = "pre-commit run trailing-whitespace --all-files"

[tasks."precommit:check-yaml"]
description = "Check YAML files (pre-commit hook)"
run = "pre-commit run check-yaml --all-files"

[tasks."precommit:check-merge-conflict"]
description = "Check for merge conflicts (pre-commit hook)"
run = "pre-commit run check-merge-conflict --all-files"

[tasks."precommit:check-large-files"]
description = "Check for large files (pre-commit hook)"
run = "pre-commit run check-added-large-files --all-files"

[tasks."precommit:check-ast"]
description = "Check Python AST (pre-commit hook)"
run = "pre-commit run check-ast --all-files"

[tasks."precommit:bandit"]
description = "Run bandit security scanner (pre-commit hook)"
run = "pre-commit run bandit --all-files"

[tasks."precommit:mypy"]
description = "Run mypy type checker (pre-commit hook)"
run = "pre-commit run mypy --all-files"

[tasks."precommit:pip-audit"]
description = "Audit pip packages (pre-commit hook)"
run = "pre-commit run pip-audit --all-files"

[tasks."precommit:detect-secrets"]
description = "Detect secrets in codebase (pre-commit hook)"
run = "pre-commit run detect-secrets --all-files"

[tasks.deps]
description = "Install all dependencies"
run = "uv sync"

[tasks."seed:models"]
description = "Seed AI models"
run = "uv run python scripts/seed_models.py --force"

[tasks."seed:workflows"]
description = "Seed workflows"
run = "uv run python scripts/seed_workflows.py"

[tasks.clean]
description = "Clean up __pycache__ and build artifacts"
run = "find . -type d -name '__pycache__' -exec rm -rf {} + && find . -type f -name '*.pyc' -delete"
